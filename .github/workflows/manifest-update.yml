name: Update GitOps Manifest

on:
  workflow_call:
    inputs:
      gitops_repo:
        description: 'GitOps repository (org/repo format)'
        required: true
        type: string
      manifest_path:
        description: 'Path to the Kubernetes manifest file to update'
        required: true
        type: string
      new_image:
        description: 'New full image reference to set'
        required: true
        type: string
      commit_message:
        description: 'Git commit message'
        required: false
        type: string
        default: ''
    secrets:
      GITOPS_REPO_TOKEN:
        description: 'PAT with write access to the gitops repository'
        required: true

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops_repo }}
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops-repo

      - name: Update and push
        env:
          NEW_IMAGE: ${{ inputs.new_image }}
          MANIFEST_PATH: ${{ inputs.manifest_path }}
          COMMIT_MESSAGE: ${{ inputs.commit_message }}
        run: |
          cd gitops-repo

          # Extract image name without tag
          IMAGE_NAME=$(echo "$NEW_IMAGE" | sed 's/:.*$//')

          # Replace image line matching the image name
          sed -i "s|image: ${IMAGE_NAME}:.*|image: ${NEW_IMAGE}|g" "$MANIFEST_PATH"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add "$MANIFEST_PATH"
          git commit -m "$COMMIT_MESSAGE" --allow-empty
          git push