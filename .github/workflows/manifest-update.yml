name: Update GitOps Manifest

on:
  workflow_call:
    inputs:
      gitops_repo:
        description: 'GitOps repository (org/repo format)'
        required: true
        type: string
      manifest_path:
        description: 'Path to the Kubernetes manifest file to update'
        required: true
        type: string
      new_image:
        description: 'New full image reference to set'
        required: true
        type: string
      commit_message:
        description: 'Git commit message'
        required: false
        type: string
        default: ''
    secrets:
      GITOPS_REPO_TOKEN:
        description: 'PAT with write access to the gitops repository'
        required: true

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops_repo }}
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops-repo

      - name: Update and push
        run: |
          cd gitops-repo

          # Extract image name without tag (escape / for sed)
          IMAGE_NAME=$(echo "${{ inputs.new_image }}" | sed 's/:.*$//' | sed 's/\//\\\//g')

          # Replace image line matching the image name
          sed -i "s/^\([[:space:]]*\)image:[[:space:]]*${IMAGE_NAME}.*/\1image: ${{ inputs.new_image }}/" "${{ inputs.manifest_path }}"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add "${{ inputs.manifest_path }}"
          git commit -m "${{ inputs.commit_message }}" --allow-empty
          git push
